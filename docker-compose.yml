services:
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: parking-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@parking-tsj.local
      PGADMIN_DEFAULT_PASSWORD: admin123
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "8081:80"
    networks:
      - parking-network
    restart: unless-stopped

  airflow-scheduler:
    image: apache/airflow:2.7.1-python3.11
    container_name: parking-airflow-scheduler
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      # Conexi√≥n al servidor PostgreSQL 13 en el puerto 5433
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:postgres1989@host.docker.internal:5433/parking_db
      AIRFLOW__DATABASE__LOAD_DEFAULT_CONNECTIONS: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: parking-etl-dev-key-123456789
    volumes:
      - ${PWD}/dags:/opt/airflow/dags
      - ${PWD}/scripts:/opt/airflow/scripts
      - ${PWD}/logs:/opt/airflow/logs
      - ${PWD}/plugins:/opt/airflow/plugins
      - ${PWD}/data:/opt/airflow/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - parking-network
    restart: unless-stopped
    command: scheduler

  airflow-webserver:
    image: apache/airflow:2.7.1-python3.11
    container_name: parking-airflow-webserver
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:postgres1989@host.docker.internal:5433/parking_db
      AIRFLOW__DATABASE__LOAD_DEFAULT_CONNECTIONS: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: parking-etl-dev-key-123456789
      AIRFLOW_WWW_USER_CREATE: "true"
      AIRFLOW_WWW_USER_USERNAME: airflow
      AIRFLOW_WWW_USER_PASSWORD: airflow123
      AIRFLOW_WWW_USER_EMAIL: airflow@parking-tsj.local
      AIRFLOW_WWW_USER_ROLE: Admin
    volumes:
      - ${PWD}/dags:/opt/airflow/dags
      - ${PWD}/scripts:/opt/airflow/scripts
      - ${PWD}/logs:/opt/airflow/logs
      - ${PWD}/plugins:/opt/airflow/plugins
      - ${PWD}/data:/opt/airflow/data
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - parking-network
    restart: unless-stopped
    command: webserver

volumes:
  pgadmin_data:

networks:
  parking-network:
    driver: bridge